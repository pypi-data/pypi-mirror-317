---
image: python:3.12-bookworm

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip_cache"
  PIP_PROGRESS_BAR: "off"
  PIP_TIMEOUT: "300"
  PYTHONDONTWRITEBYTECODE: "1"

cache:
  paths:
    - .pip_cache
    - .venv

stages:
  - 🐞 testing
  - 📦 building
  - 🚢 publishing

before_script:
  - python -VV
  - python -m venv --copies --upgrade-deps .venv
  - source .venv/bin/activate

code quality:
  stage: 🐞 testing
  script:
    - make install
    - make linting
    - make coverage
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 1 day
    reports:
      junit: pytest.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

build package:
  stage: 📦 building
  script: make build
  artifacts:
    expire_in: 1 day
    paths:
      - dist
  only:
    - tags

deployment:
  stage: 🚢 publishing
  dependencies:
    - build package
  script: make release
  environment:
    name: PyPI
    url: https://pypi.org/project/jsonrpc-py
  only:
    - tags

pages:
  stage: 🚢 publishing
  script: make docs
  environment:
    name: GitLab Pages
    url: https://docs.jsonrpc.ru
  artifacts:
    paths:
      - public
    expire_in: 1 day
  only:
    - tags
